<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

    <div id="app">
        <form id="form">
            <input type="text" id="query" placeholder="Search for podcasts">
            <input type="submit" value="Search" id="search">
        </form>

        <br />

        <div id="results"></div>
    </div>

    <script>
        const searchRequest = async data => {
            const response = await fetch("http://127.0.0.1:9200/podcasts/_search", {
                mode: "cors",
                method: "post",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            return await response.json();
        };

        const metadataRequest = async id => {
            const response = await fetch("http://127.0.0.1:9200/metadata/_doc/" + id, {
                mode: "cors",
                method: "get",
                headers: { "Content-Type": "application/json" },
            });

            return await response.json();
        };

        document.getElementById("search").addEventListener("click", async e => {
            e.preventDefault();

            document.getElementById("results").innerHTML = "";

            // step 1. search
            const searchData = {
                "query": {
                    "query_string": {
                        "query": document.getElementById("query").value,
                        "fields": ["results.alternatives.transcript", "results.alternatives.words.word"]
                    }
                },
                "highlight": {
                    "order": "score",
                    "fields": {
                        "results.alternatives.transcript": {
                            "fragment_size": 300,
                            "number_of_fragments": 5
                        }
                    }
                }
            };

            const data = await searchRequest(searchData);
            console.log(data);

            // step 2. print out all episodes
            for (episode of data.hits.hits) {
                console.log(episode);

                const metadata = await metadataRequest(episode._id);
                console.log(metadata);

                document.getElementById("results").innerHTML += "PODCAST NAME: " + metadata._source.show_name + "<br />";
                document.getElementById("results").innerHTML += "EPISODE NAME: " + metadata._source.episode_name + "<br />";
                document.getElementById("results").innerHTML += "HIGHLIGHTS: <br />";
                
                for (highlight of episode.highlight["results.alternatives.transcript"]) {
                    document.getElementById("results").innerHTML += "<ul>" + highlight + "</ul>";
                }

                document.getElementById("results").innerHTML += "<br /> <br /> <br />";
            }
        });
    </script>

</body>

</html>